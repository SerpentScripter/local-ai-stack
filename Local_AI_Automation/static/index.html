<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TR Local AI Hub</title>
    <meta name="description" content="Local AI orchestration platform for managing LLMs, agents, and workflows">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/main.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>

<body>
    <!-- Skip Navigation Link for Accessibility -->
    <a href="#main-content" class="skip-link">Skip to main content</a>

    <div class="container">
        <header role="banner">
            <div>
                <h1>TR Local AI Hub</h1>
                <p style="color: var(--text-secondary)">Unified Management Dashboard</p>
            </div>
            <div class="header-controls">
                <div class="status-badge" role="status" aria-live="polite">
                    <span>API</span>
                    <span class="indicator" id="connection-status" title="Checking..." aria-label="API connection status"></span>
                </div>
                <button class="refresh-btn" onclick="refreshAll()" aria-label="Refresh all dashboard data">Refresh All</button>
            </div>
        </header>

        <!-- Main Content -->
        <main id="main-content" role="main">

        <!-- Agent Job Launcher -->
        <section class="card" style="margin-bottom: 2rem;" aria-labelledby="agent-launcher-heading">
            <div class="module-header">
                <h3 id="agent-launcher-heading">Start Agent Job</h3>
            </div>
            <div style="display: flex; gap: 1rem;">
                <label for="agent-input" class="visually-hidden">Agent command input</label>
                <input type="text" id="agent-input"
                    placeholder="e.g., 'Research quantum computing' or 'Create a new snake game project'"
                    aria-describedby="agent-input-help"
                    style="flex: 1; padding: 1rem; border-radius: 0.75rem; border: 1px solid rgba(255,255,255,0.1); background: rgba(0,0,0,0.2); color: white; font-size: 1rem;">
                <button class="btn btn-primary" onclick="triggerAgent()" aria-label="Launch agent job">Launch</button>
            </div>
            <div id="agent-input-help" class="visually-hidden">Enter a research topic or project creation command</div>
            <div id="agent-status" role="status" aria-live="polite" style="margin-top: 1rem; color: var(--text-secondary); font-size: 0.875rem;"></div>
        </section>

        <!-- Main Dashboard Grid -->
        <div class="grid-2" style="margin-bottom: 2rem;" role="region" aria-label="Dashboard overview">
            <!-- Service Control Panel -->
            <section class="module-card" id="service-control-panel" aria-labelledby="service-control-heading">
                <div class="module-header">
                    <h3 id="service-control-heading">Service Control</h3>
                    <button class="btn-icon" onclick="loadServices()" title="Refresh services" aria-label="Refresh service status">‚Üª</button>
                </div>
                <div class="service-grid" id="service-grid" role="list" aria-live="polite">
                    <p style="color: var(--text-secondary)">Loading services...</p>
                </div>
            </section>

            <!-- System Monitor Panel -->
            <section class="module-card" id="system-monitor-panel" aria-labelledby="system-monitor-heading">
                <div class="module-header">
                    <h3 id="system-monitor-heading">System Monitor</h3>
                    <button class="btn-icon" onclick="loadMetrics()" title="Refresh metrics" aria-label="Refresh system metrics">‚Üª</button>
                </div>
                <div class="metrics-grid" role="group" aria-label="System metrics">
                    <div class="metric-card" role="meter" aria-label="CPU usage" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                        <div class="metric-header">
                            <span class="metric-label">CPU</span>
                            <span class="metric-value" id="cpu-value" aria-live="polite">--%</span>
                        </div>
                        <div class="chart-container" aria-hidden="true">
                            <canvas id="cpu-chart"></canvas>
                        </div>
                    </div>
                    <div class="metric-card" role="meter" aria-label="Memory usage" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                        <div class="metric-header">
                            <span class="metric-label">Memory</span>
                            <span class="metric-value" id="memory-value" aria-live="polite">--%</span>
                        </div>
                        <div class="chart-container" aria-hidden="true">
                            <canvas id="memory-chart"></canvas>
                        </div>
                    </div>
                    <div class="metric-card" role="meter" aria-label="GPU usage" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                        <div class="metric-header">
                            <span class="metric-label">GPU</span>
                            <span class="metric-value" id="gpu-value" aria-live="polite">--</span>
                        </div>
                        <div class="chart-container" aria-hidden="true">
                            <canvas id="gpu-chart"></canvas>
                        </div>
                    </div>
                    <div class="metric-card" role="meter" aria-label="Disk usage" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                        <div class="metric-header">
                            <span class="metric-label">Disk</span>
                            <span class="metric-value" id="disk-value" aria-live="polite">--%</span>
                        </div>
                        <div class="disk-bar" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
                            <div class="disk-used" id="disk-bar-fill" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <!-- LLM Chat Panel -->
        <section class="module-card" style="margin-bottom: 2rem;" aria-labelledby="chat-heading">
            <div class="module-header">
                <h3 id="chat-heading">LLM Chat</h3>
                <div style="display: flex; gap: 0.5rem; align-items: center;">
                    <label for="model-selector" class="visually-hidden">Select AI model</label>
                    <select id="model-selector" class="model-select" aria-label="Select AI model">
                        <option value="">Loading models...</option>
                    </select>
                    <button class="btn-icon" onclick="clearChat()" title="Clear chat history" aria-label="Clear chat history">üóë</button>
                </div>
            </div>
            <div class="chat-messages" id="chat-messages" role="log" aria-live="polite" aria-label="Chat messages">
                <div class="chat-welcome">
                    <p>Select a model above and start chatting with your local LLM.</p>
                </div>
            </div>
            <div class="chat-input-area" role="form">
                <label for="chat-input" class="visually-hidden">Chat message input</label>
                <textarea id="chat-input" placeholder="Type your message... (Enter to send)" rows="2" aria-label="Type your message"></textarea>
                <button id="chat-send-btn" class="btn btn-primary" onclick="sendChatMessage()" aria-label="Send message">Send</button>
            </div>
        </section>

        <!-- Workflow Builder Panel -->
        <section class="module-card" style="margin-bottom: 2rem;" aria-labelledby="workflow-heading">
            <div class="module-header">
                <h3 id="workflow-heading">Workflow Presets</h3>
                <label for="workflow-preset-select" class="visually-hidden">Select workflow preset</label>
                <select id="workflow-preset-select" class="preset-select" onchange="loadWorkflowPreset(this.value)" aria-label="Select workflow preset">
                    <option value="">Select a workflow...</option>
                </select>
            </div>
            <div class="workflow-canvas-container">
                <svg id="workflow-canvas" class="workflow-canvas" width="100%" height="200" role="img" aria-label="Workflow diagram">
                    <title>Workflow visualization</title>
                    <defs>
                        <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                            <polygon points="0 0, 10 3.5, 0 7" fill="var(--accent-primary)" />
                        </marker>
                    </defs>
                    <g id="connections-layer"></g>
                    <g id="nodes-layer"></g>
                </svg>
                <div class="workflow-empty" id="workflow-empty">
                    <p>Select a preset workflow to visualize</p>
                </div>
            </div>
            <div class="workflow-info" id="workflow-info" style="display: none;" role="region" aria-live="polite">
                <div class="info-name" id="workflow-name"></div>
                <div class="info-description" id="workflow-description"></div>
            </div>
        </section>

        <!-- Agent Timeline Section -->
        <section class="module-card" style="margin-bottom: 2rem;" aria-labelledby="timeline-heading">
            <div class="module-header">
                <h3 id="timeline-heading">Agent Execution Timeline</h3>
                <div style="display: flex; gap: 0.5rem; align-items: center;">
                    <label for="timeline-hours" class="visually-hidden">Time range</label>
                    <select id="timeline-hours" class="model-select" onchange="loadTimeline()" aria-label="Select time range">
                        <option value="1">Last Hour</option>
                        <option value="6">Last 6 Hours</option>
                        <option value="24" selected>Last 24 Hours</option>
                        <option value="168">Last Week</option>
                    </select>
                    <button class="btn-icon" onclick="loadTimeline()" title="Refresh timeline" aria-label="Refresh timeline">‚Üª</button>
                </div>
            </div>
            <div id="timeline-container" class="timeline-container" role="list" aria-live="polite" aria-label="Agent execution history">
                <div class="timeline-empty">
                    <p style="color: var(--text-secondary)">Loading timeline...</p>
                </div>
            </div>
            <div id="timeline-stats" class="timeline-stats" style="display: none;" role="status" aria-live="polite">
                <span id="timeline-total"></span>
                <span id="timeline-completed"></span>
                <span id="timeline-failed"></span>
            </div>
        </section>

        <!-- Backlog Section -->
        <section class="card" style="margin-bottom: 2rem;" aria-labelledby="backlog-heading">
            <div class="section-header">
                <h2 id="backlog-heading">Active Backlog</h2>
                <button class="btn btn-primary" onclick="alert('Coming soon')" aria-label="Add new backlog item">+ New Item</button>
            </div>
            <div style="overflow-x: auto;" role="region" aria-label="Backlog items table" tabindex="0">
                <table role="table" aria-label="Backlog items">
                    <thead>
                        <tr>
                            <th scope="col">ID</th>
                            <th scope="col">Priority</th>
                            <th scope="col">Title</th>
                            <th scope="col">Category</th>
                            <th scope="col">Status</th>
                        </tr>
                    </thead>
                    <tbody id="backlog-body" aria-live="polite"></tbody>
                </table>
            </div>
        </section>

        </main><!-- End of main content -->

        <!-- Research & Projects -->
        <div class="grid-2">
            <div class="card">
                <div class="module-header">
                    <h3>Recent Research</h3>
                    <button class="btn-icon" onclick="loadResearch()">‚Üª</button>
                </div>
                <div id="research-list" style="font-size: 0.875rem; max-height: 200px; overflow-y: auto;">
                    <p style="color: var(--text-secondary)">Loading...</p>
                </div>
            </div>
            <div class="card">
                <div class="module-header">
                    <h3>Active Projects</h3>
                    <button class="btn-icon" onclick="loadProjects()">‚Üª</button>
                </div>
                <div id="project-list" style="font-size: 0.875rem; max-height: 200px; overflow-y: auto;">
                    <p style="color: var(--text-secondary)">Loading...</p>
                </div>
            </div>
        </div>

        <footer>
            TR Local AI Automation Stack &bull; Fully Local &bull; Private &bull; Secure
        </footer>
    </div>

    <div id="toast-container" class="toast-container"></div>

    <script>
        const API = window.location.origin;
        let charts = {};
        let metricsHistory = { cpu: [], memory: [], gpu: [] };
        let workflowPresets = [];
        let isStreaming = false;

        // ============================================
        // INITIALIZATION
        // ============================================
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('[Dashboard] Initializing...');

            // Check API health
            checkHealth();

            // Load all data
            await Promise.all([
                loadServices(),
                loadModels(),
                loadWorkflowPresets(),
                loadBacklog(),
                loadResearch(),
                loadProjects(),
                loadTimeline()
            ]);

            // Initialize charts
            initCharts();

            // Start metrics polling
            loadMetrics();
            setInterval(loadMetrics, 5000);

            // Refresh timeline periodically
            setInterval(loadTimeline, 30000);

            // Chat input handler
            document.getElementById('chat-input').addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendChatMessage();
                }
            });

            console.log('[Dashboard] Ready');
        });

        // ============================================
        // HEALTH CHECK
        // ============================================
        async function checkHealth() {
            const indicator = document.getElementById('connection-status');
            try {
                const res = await fetch(`${API}/health`);
                if (res.ok) {
                    indicator.className = 'indicator on';
                    indicator.title = 'Connected';
                } else {
                    indicator.className = 'indicator off';
                    indicator.title = 'Error';
                }
            } catch (e) {
                indicator.className = 'indicator off';
                indicator.title = 'Disconnected';
            }
        }

        // ============================================
        // SERVICES
        // ============================================
        async function loadServices() {
            const grid = document.getElementById('service-grid');
            try {
                const services = await fetch(`${API}/services`).then(r => r.json());
                grid.innerHTML = services.map(svc => `
                    <div class="service-card" data-service="${svc.id}">
                        <div class="service-header">
                            <span class="service-name">${svc.name}</span>
                            <span class="indicator ${svc.status === 'running' ? 'on' : 'off'}"></span>
                        </div>
                        <div class="service-info">
                            <span>Port: ${svc.port}</span>
                            <span>${svc.type}</span>
                        </div>
                        <div class="service-actions">
                            <button class="btn-sm btn-success" onclick="serviceAction('${svc.id}', 'start')" ${svc.status === 'running' ? 'disabled' : ''}>Start</button>
                            <button class="btn-sm btn-danger" onclick="serviceAction('${svc.id}', 'stop')" ${svc.status !== 'running' ? 'disabled' : ''}>Stop</button>
                            <button class="btn-sm" onclick="serviceAction('${svc.id}', 'restart')">Restart</button>
                        </div>
                        ${svc.status === 'running' ? `
                            <div class="service-links">
                                <a href="http://localhost:${svc.port}" target="_blank" class="btn-link">Open</a>
                            </div>
                        ` : ''}
                    </div>
                `).join('');
            } catch (e) {
                grid.innerHTML = '<p style="color: var(--danger)">Failed to load services</p>';
            }
        }

        async function serviceAction(id, action) {
            showToast(`${action}ing ${id}...`, 'info');
            try {
                await fetch(`${API}/services/${id}/${action}`, { method: 'POST' });
                setTimeout(loadServices, 2000);
            } catch (e) {
                showToast(`Error: ${e.message}`, 'error');
            }
        }

        // ============================================
        // METRICS & CHARTS
        // ============================================
        function initCharts() {
            if (typeof Chart === 'undefined') {
                console.warn('[Charts] Chart.js not loaded');
                return;
            }

            // Destroy any existing charts first
            Object.values(charts).forEach(chart => {
                if (chart) chart.destroy();
            });
            charts = {};

            ['cpu', 'memory', 'gpu'].forEach(metric => {
                const canvas = document.getElementById(`${metric}-chart`);
                if (!canvas) return;

                const container = canvas.parentElement;
                const color = metric === 'gpu' ? '#a855f7' : metric === 'memory' ? '#22c55e' : '#6366f1';

                charts[metric] = new Chart(canvas, {
                    type: 'line',
                    data: {
                        labels: Array(30).fill(''),
                        datasets: [{
                            data: Array(30).fill(0),
                            borderColor: color,
                            borderWidth: 2,
                            fill: true,
                            backgroundColor: color + '20'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        resizeDelay: 0,
                        plugins: { legend: { display: false } },
                        scales: {
                            x: { display: false },
                            y: { display: false, min: 0, max: 100 }
                        },
                        elements: {
                            point: { radius: 0 },
                            line: { tension: 0.4 }
                        },
                        animation: false
                    }
                });
            });
        }

        async function loadMetrics() {
            try {
                const m = await fetch(`${API}/system/metrics`).then(r => r.json());

                document.getElementById('cpu-value').textContent = `${m.cpu_percent.toFixed(1)}%`;
                document.getElementById('memory-value').textContent = `${m.memory_percent.toFixed(1)}%`;
                document.getElementById('gpu-value').textContent = m.gpu_percent != null ? `${m.gpu_percent.toFixed(1)}%` : 'N/A';
                document.getElementById('disk-value').textContent = `${m.disk_percent.toFixed(1)}%`;
                document.getElementById('disk-bar-fill').style.width = `${m.disk_percent}%`;

                // Update charts
                ['cpu', 'memory', 'gpu'].forEach(metric => {
                    if (!charts[metric]) return;
                    const val = m[`${metric}_percent`] || 0;
                    metricsHistory[metric].push(val);
                    if (metricsHistory[metric].length > 30) metricsHistory[metric].shift();
                    charts[metric].data.datasets[0].data = [...metricsHistory[metric]];
                    while (charts[metric].data.datasets[0].data.length < 30) {
                        charts[metric].data.datasets[0].data.unshift(0);
                    }
                    charts[metric].update('none');
                });
            } catch (e) {
                console.error('[Metrics] Error:', e);
            }
        }

        // ============================================
        // LLM CHAT
        // ============================================
        async function loadModels() {
            const select = document.getElementById('model-selector');
            try {
                const data = await fetch(`${API}/chat/models`).then(r => r.json());
                const models = data.models || [];
                select.innerHTML = models.length > 0
                    ? models.map(m => `<option value="${m.name}">${m.name}</option>`).join('')
                    : '<option value="">No models available</option>';
            } catch (e) {
                select.innerHTML = '<option value="">Error loading models</option>';
            }
        }

        async function sendChatMessage() {
            const input = document.getElementById('chat-input');
            const select = document.getElementById('model-selector');
            const messages = document.getElementById('chat-messages');
            const message = input.value.trim();
            const model = select.value;

            if (!message || !model || isStreaming) return;

            // Remove welcome
            const welcome = messages.querySelector('.chat-welcome');
            if (welcome) welcome.remove();

            // Add user message
            messages.innerHTML += `
                <div class="chat-message user">
                    <div class="message-avatar">üë§</div>
                    <div class="message-content">${escapeHtml(message)}</div>
                </div>
            `;

            // Add assistant placeholder
            const assistantId = 'msg-' + Date.now();
            messages.innerHTML += `
                <div class="chat-message assistant streaming" id="${assistantId}">
                    <div class="message-avatar">ü§ñ</div>
                    <div class="message-content">...</div>
                </div>
            `;
            messages.scrollTop = messages.scrollHeight;

            input.value = '';
            isStreaming = true;

            try {
                const eventSource = new EventSource(`${API}/chat/stream?prompt=${encodeURIComponent(message)}&model=${encodeURIComponent(model)}`);
                let fullResponse = '';
                const contentEl = document.querySelector(`#${assistantId} .message-content`);

                eventSource.onmessage = (e) => {
                    const data = JSON.parse(e.data);
                    if (data.error) {
                        contentEl.textContent = 'Error: ' + data.error;
                        eventSource.close();
                        isStreaming = false;
                        return;
                    }
                    if (data.token) {
                        fullResponse += data.token;
                        contentEl.innerHTML = formatMarkdown(fullResponse);
                        messages.scrollTop = messages.scrollHeight;
                    }
                    if (data.done) {
                        eventSource.close();
                        isStreaming = false;
                        document.getElementById(assistantId).classList.remove('streaming');
                    }
                };

                eventSource.onerror = () => {
                    eventSource.close();
                    isStreaming = false;
                    if (!fullResponse) contentEl.textContent = 'Connection error';
                };
            } catch (e) {
                isStreaming = false;
            }
        }

        function clearChat() {
            document.getElementById('chat-messages').innerHTML = `
                <div class="chat-welcome">
                    <p>Chat cleared. Select a model and start a new conversation.</p>
                </div>
            `;
        }

        function formatMarkdown(text) {
            return text
                .replace(/```(\w*)\n([\s\S]*?)```/g, '<pre><code>$2</code></pre>')
                .replace(/`([^`]+)`/g, '<code>$1</code>')
                .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
                .replace(/\n/g, '<br>');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ============================================
        // WORKFLOWS
        // ============================================
        async function loadWorkflowPresets() {
            try {
                workflowPresets = await fetch(`${API}/workflows/presets`).then(r => r.json());
                const select = document.getElementById('workflow-preset-select');
                select.innerHTML = '<option value="">Select a workflow...</option>' +
                    workflowPresets.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
            } catch (e) {
                console.error('[Workflows] Error:', e);
            }
        }

        function loadWorkflowPreset(id) {
            if (!id) {
                document.getElementById('workflow-empty').style.display = 'block';
                document.getElementById('workflow-info').style.display = 'none';
                document.getElementById('nodes-layer').innerHTML = '';
                document.getElementById('connections-layer').innerHTML = '';
                return;
            }

            const preset = workflowPresets.find(p => p.id === id);
            if (!preset) return;

            document.getElementById('workflow-empty').style.display = 'none';
            document.getElementById('workflow-info').style.display = 'block';
            document.getElementById('workflow-name').textContent = preset.name;
            document.getElementById('workflow-description').textContent = preset.description;

            renderWorkflow(preset);
        }

        function renderWorkflow(workflow) {
            const nodesLayer = document.getElementById('nodes-layer');
            const connectionsLayer = document.getElementById('connections-layer');
            nodesLayer.innerHTML = '';
            connectionsLayer.innerHTML = '';

            // Render nodes
            workflow.nodes.forEach(node => {
                const icon = { input: 'üì•', output: 'üì§', service: 'ü§ñ', agent: 'üîß', tool: 'üõ†Ô∏è' }[node.type] || 'üì¶';
                const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                g.setAttribute('transform', `translate(${node.x}, ${node.y})`);
                g.innerHTML = `
                    <rect width="120" height="50" rx="8" fill="var(--card-bg-solid)" stroke="var(--glass-border)" stroke-width="2"/>
                    <text x="15" y="32" font-size="16">${icon}</text>
                    <text x="40" y="30" fill="var(--text-primary)" font-size="12">${node.label.substring(0, 10)}</text>
                    <circle cx="0" cy="25" r="5" fill="var(--accent-primary)"/>
                    <circle cx="120" cy="25" r="5" fill="var(--accent-primary)"/>
                `;
                nodesLayer.appendChild(g);
            });

            // Render connections
            workflow.connections.forEach(conn => {
                const from = workflow.nodes.find(n => n.id === conn.from);
                const to = workflow.nodes.find(n => n.id === conn.to);
                if (!from || !to) return;

                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                const sx = from.x + 120, sy = from.y + 25;
                const ex = to.x, ey = to.y + 25;
                const dx = (ex - sx) / 2;
                path.setAttribute('d', `M ${sx} ${sy} C ${sx + dx} ${sy}, ${ex - dx} ${ey}, ${ex} ${ey}`);
                path.setAttribute('fill', 'none');
                path.setAttribute('stroke', 'var(--accent-primary)');
                path.setAttribute('stroke-width', '2');
                path.setAttribute('marker-end', 'url(#arrowhead)');
                connectionsLayer.appendChild(path);
            });
        }

        // ============================================
        // BACKLOG, RESEARCH, PROJECTS
        // ============================================
        async function loadBacklog() {
            try {
                const items = await fetch(`${API}/items?limit=10&status=open`).then(r => r.json());
                document.getElementById('backlog-body').innerHTML = items.map(item => `
                    <tr>
                        <td><code>${item.external_id}</code></td>
                        <td><span class="priority-badge ${item.priority.toLowerCase()}">${item.priority}</span></td>
                        <td>${item.title}</td>
                        <td style="color: var(--text-secondary)">${item.category}</td>
                        <td>${item.status}</td>
                    </tr>
                `).join('') || '<tr><td colspan="5" style="color: var(--text-secondary)">No items</td></tr>';
            } catch (e) {
                document.getElementById('backlog-body').innerHTML = '<tr><td colspan="5" style="color: var(--danger)">Error loading backlog</td></tr>';
            }
        }

        async function loadResearch() {
            try {
                const sessions = await fetch(`${API}/agent/research`).then(r => r.json());
                document.getElementById('research-list').innerHTML = sessions.length > 0
                    ? sessions.map(s => `<div style="margin-bottom: 0.5rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--glass-border);"><div style="font-weight: 600; color: var(--accent-secondary);">${s.goal}</div><div style="font-size: 0.8rem; color: var(--text-secondary);">${s.status}</div></div>`).join('')
                    : '<p style="color: var(--text-secondary)">No research sessions</p>';
            } catch (e) {
                document.getElementById('research-list').innerHTML = '<p style="color: var(--text-secondary)">No sessions</p>';
            }
        }

        async function loadProjects() {
            try {
                const projects = await fetch(`${API}/agent/projects`).then(r => r.json());
                document.getElementById('project-list').innerHTML = projects.length > 0
                    ? projects.map(p => `<div style="margin-bottom: 0.5rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--glass-border);"><div style="font-weight: 600; color: var(--success);">${p.name}</div><div style="font-size: 0.8rem; color: var(--text-secondary);">${p.goal}</div></div>`).join('')
                    : '<p style="color: var(--text-secondary)">No active projects</p>';
            } catch (e) {
                document.getElementById('project-list').innerHTML = '<p style="color: var(--text-secondary)">No projects</p>';
            }
        }

        // ============================================
        // AGENT TIMELINE
        // ============================================
        async function loadTimeline() {
            const container = document.getElementById('timeline-container');
            const stats = document.getElementById('timeline-stats');
            const hours = document.getElementById('timeline-hours')?.value || 24;

            try {
                const data = await fetch(`${API}/orchestration/timeline?hours=${hours}&limit=50`).then(r => r.json());

                if (data.events && data.events.length > 0) {
                    container.innerHTML = data.events.map(event => {
                        const icon = event.type === 'agent_execution' ? 'ü§ñ' : '‚öôÔ∏è';
                        const timeStr = formatTimeAgo(event.start_time);
                        const duration = event.end_time ? formatDuration(event.start_time, event.end_time) : 'Running...';

                        return `
                            <div class="timeline-event type-${event.type} status-${event.status}">
                                <div class="timeline-icon">${icon}</div>
                                <div class="timeline-content">
                                    <div class="timeline-title" title="${event.details?.goal || event.title}">${event.title}</div>
                                    <div class="timeline-meta">
                                        <span class="timeline-time">${timeStr}</span>
                                        <span class="timeline-status ${event.status}">${event.status}</span>
                                        <span>${duration}</span>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');

                    // Update stats
                    const completed = data.events.filter(e => e.status === 'completed' || e.status === 'finished').length;
                    const failed = data.events.filter(e => e.status === 'failed').length;

                    stats.style.display = 'flex';
                    document.getElementById('timeline-total').innerHTML = `<span class="dot total"></span> Total: ${data.count}`;
                    document.getElementById('timeline-completed').innerHTML = `<span class="dot completed"></span> Completed: ${completed}`;
                    document.getElementById('timeline-failed').innerHTML = `<span class="dot failed"></span> Failed: ${failed}`;
                } else {
                    container.innerHTML = '<div class="timeline-empty"><p style="color: var(--text-secondary)">No agent activity in this time period</p></div>';
                    stats.style.display = 'none';
                }
            } catch (e) {
                container.innerHTML = '<div class="timeline-empty"><p style="color: var(--text-secondary)">Timeline data unavailable</p></div>';
                stats.style.display = 'none';
            }
        }

        function formatTimeAgo(isoString) {
            if (!isoString) return 'Unknown';
            const date = new Date(isoString);
            const now = new Date();
            const diff = Math.floor((now - date) / 1000);

            if (diff < 60) return 'Just now';
            if (diff < 3600) return `${Math.floor(diff / 60)}m ago`;
            if (diff < 86400) return `${Math.floor(diff / 3600)}h ago`;
            return `${Math.floor(diff / 86400)}d ago`;
        }

        function formatDuration(start, end) {
            if (!start || !end) return '';
            const diff = Math.floor((new Date(end) - new Date(start)) / 1000);
            if (diff < 60) return `${diff}s`;
            if (diff < 3600) return `${Math.floor(diff / 60)}m ${diff % 60}s`;
            return `${Math.floor(diff / 3600)}h ${Math.floor((diff % 3600) / 60)}m`;
        }

        // ============================================
        // AGENT LAUNCHER
        // ============================================
        async function triggerAgent() {
            const input = document.getElementById('agent-input');
            const status = document.getElementById('agent-status');
            const prompt = input.value.trim();
            if (!prompt) return;

            status.innerHTML = 'Analyzing intent...';
            try {
                const route = await fetch(`${API}/agent/router?prompt=${encodeURIComponent(prompt)}`, { method: 'POST' }).then(r => r.json());
                status.innerHTML = `Intent: <strong>${route.intent}</strong>`;

                if (route.intent === 'RESEARCH') {
                    await fetch(`${API}/agent/research?goal=${encodeURIComponent(prompt)}&limit=10`, { method: 'POST' });
                    status.innerHTML += ' ‚Üí Started Research Agent';
                    input.value = '';
                } else if (route.intent === 'PROJECT') {
                    await fetch(`${API}/agent/project?goal=${encodeURIComponent(prompt)}`, { method: 'POST' });
                    status.innerHTML += ' ‚Üí Started Project Agent';
                    input.value = '';
                }
            } catch (e) {
                status.innerHTML = `Error: ${e.message}`;
            }
        }

        // ============================================
        // UTILITIES
        // ============================================
        function refreshAll() {
            loadServices();
            loadMetrics();
            loadModels();
            loadBacklog();
            loadResearch();
            loadProjects();
            loadTimeline();
            checkHealth();
            showToast('Refreshed all data', 'success');
        }

        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.innerHTML = `<span>${message}</span>`;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }
    </script>
</body>
</html>
